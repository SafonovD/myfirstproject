<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Главная Страница</title>

    <div th:replace="fragments/header::header-css"></div>
</head>
<body>

<div th:replace="fragments/header:: header"></div>
<br><br><br><br><br><br>

<div class="container mt-5">

    <div class="con"><h3><label th:text="${examName}">Добро пожаловать на тест!</label></h3>


            <div class="form-group">
                <!--Таймер-->
                <input type="hidden" th:id="examTime" th:value="${examTime}">
                <div>Оставшееся время: <span id="tm"></span></div>
            </div>
            <!--    Вопросы-->
            <div class="form-group col-xs-8">
                <label for="questions">Выберите вопрос</label>
                <select class="form-control" id="questions" size="1"></select>
            </div>
            <div class="form-group col-sm-10 ">
                <!--    Вопрос-->
                <div class="form-group"><p id="question"></p></div>
                <!--    варианты ответов-->
                <div class="form-check" id="answers"></div>
            </div>

        <!-- кнопка следующего вопрос и завершить и сохранить-->

            <div class="form-group col-xs-8">
                <input class="btn btn-primary" id="next" type="button" value="Следующий вопрос"/>

                <form id="forma" th:action="@{/test/save}" th:object="${results}" th:method="post"
                      th:if="${not #lists.isEmpty(results)}">

                    <input type="hidden" th:fild="*{id}"/>
                    <input type="hidden" th:fild="*{examId}"/>
                    <input type="hidden" id="useranswers" th:fild="*{answers}"/>

                    <input class="btn btn-danger form-group" id="done" type="submit" value="Завершить"/>
                </form>
            </div>

    </div>
</div>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<script th:inline="javascript">
    var userAnswers = {};
    /*<![CDATA[*/
    var questions = /*[[${questions}]]*/ [{'id': 1, 'multiAnswer': false, 'name': 'Вопрос?'}];
    /*]]>*/
    $(document).ready(function () {
        $("#next").click(nextHandler);
        var q = $("#questions");
        $.each(questions, function () {
            q.append($("<option />").val(this.id).text(this.name));
        });

        comboHandler(); // Старт
        q.change(comboHandler);

        function comboHandler() {
            var elm = $('#questions option:selected');
            var i = elm.index();
            $("#question").text(questions[i].name);
            loadAnswers(questions[i].id, questions[i].multiAnswer);
        }

        function loadAnswers(id, isMulti) {
            var url = location.protocol + '//' + location.host + '/answers/' + id;
            var answers = $('#answers');
            answers.empty();
            $.ajax({
                url: url,
                dataType: 'json',
                type: 'GET',
                success: function (data, status) {
                    var elmType = isMulti ? "checkbox" : "radio";
                    $.each(data, function (i, v) {
                        var btn = $("<input />", {type: elmType, name: 'answer', value: v.id, id: v.id});
                        if (userAnswers[v.id]) {
                            btn.attr("checked", true);
                        }
                        var lab = $("<label />", {html: btn}).append(v.name);
                        answers.append(btn, [lab, $("<br />")]);
                    });
                },
                error: function () {
                }
            });
        }

        // кнопка обработки ответа - сохранить результат и перейти к следующему вопросу
        function nextHandler() {
            var answers = $('#answers').children('input');
            $.each(answers, function (i, elm) {
                userAnswers[elm.id] = elm.checked;
            });
            var elm = $('#questions option:selected');
            var len = $('#questions').children('option').length;
            var i = elm.index();
            /*<![CDATA[*/
            if (i == (len - 1)) {
                $('#questions option:first-child').attr("selected", "selected");
            } else {
                $('#questions option:selected').next('option').attr('selected', 'selected');
            }
            $('#questions').change();
            /*]]>*/
        }

        $("form").submit(function (event) {
            let ua = [];
            for (const k in userAnswers) {
                if (userAnswers[k]) ua.push(k);
            }
            $("#useranswers").val(ua);
        });

        // Таймер времени
        var countDownTimer = parseInt($('#examTime').val());

        function timerFunction() {
            var m = ((countDownTimer / 60) >> 0);
            var s = (countDownTimer % 60);
            $('#tm').text(("00" + m).slice(-2) + ':' + ("00" + s).slice(-2));
            if (countDownTimer == 0) {
                $('#done').click();
            }
            countDownTimer -= 1;
        }

        setInterval(timerFunction, 1000);
    });
</script>

<!-- /.container -->

<div th:replace="fragments/footer.html :: footer"></div>

</body>
</html>